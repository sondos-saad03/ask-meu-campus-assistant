import OpenAI from 'openai';

// ูุงุนุฏุฉ ุจูุงูุงุช ูุนูููุงุช ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท
const MEU_KNOWLEDGE_BASE = {
  // ูุนูููุงุช ุนุงูุฉ ุนู ุงูุฌุงูุนุฉ
  general: {
    name: 'ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท',
    englishName: 'Middle East University',
    location: 'ุนูุงูุ ุงูุฃุฑุฏู',
    founded: '2005',
    type: 'ุฌุงูุนุฉ ุฎุงุตุฉ',
    accreditation: 'ูุนุชูุฏุฉ ูู ูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู ูุงูุจุญุซ ุงูุนููู ุงูุฃุฑุฏููุฉ',
    website: 'www.meu.edu.jo'
  },

  // ูุนูููุงุช ุงูุชุณุฌูู
  registration: {
    'ุชุณุฌูู ุงูููุงุฏ': 'ูุชู ุงูุชุณุฌูู ุฅููุชุฑูููุงู ุนุจุฑ ูุธุงู ุงูุทุงูุจ ุงูุฅููุชุฑููู. ููุงุนูุฏ ุงูุชุณุฌูู ุชูุนูู ูุจู ุจุฏุงูุฉ ูู ูุตู. ูุญู ููุทุงูุจ ุชุณุฌูู 12-18 ุณุงุนุฉ ูุนุชูุฏุฉ ูู ุงููุตู ุงูุนุงุฏู.',
    'ุงูุฑุณูู': 'ุชุฎุชูู ุงูุฑุณูู ุญุณุจ ุงูุชุฎุตุต. ูุชู ุฏูุน ุงูุฑุณูู ุนุจุฑ ุงูุจููู ุงููุนุชูุฏุฉ ุฃู ุนุจุฑ ุงููููุน ุงูุฅููุชุฑููู. ููุฌุฏ ุฎุตููุงุช ูููุชููููู ูุฃุจูุงุก ุงูููุชุณุจูู.',
    'ุงูููุญ': 'ุชูุฏู ุงูุฌุงูุนุฉ ููุญ ุฌุฒุฆูุฉ ููุงููุฉ ููุทูุจุฉ ุงููุชููููู. ููุญุฉ ุงูุชููุฒ ุงูุฃูุงุฏููู ููุญุงุตููู ุนูู ูุนุฏู 90% ูุฃูุซุฑ ูู ุงูุซุงูููุฉ ุงูุนุงูุฉ.',
    'ุงูุงูุณุญุงุจ': 'ูููู ุงูุงูุณุญุงุจ ูู ุงูููุงุฏ ุฎูุงู ุงูุฃุณุงุจูุน ุงูุฃููู ูู ุงููุตู. ุจุนุฏ ุฐูู ููุณุฌู ุงูุณุญุงุจ ููุคุซุฑ ุนูู ุงููุนุฏู.',
    'ุงูุชุฃุฌูู': 'ูููู ุชุฃุฌูู ุงููุตู ูุฃุณุจุงุจ ูุจุฑุฑุฉ ุจุนุฏ ุชูุฏูู ุทูุจ ุฑุณูู ูุนูุงุฏุฉ ุงููุจูู ูุงูุชุณุฌูู.'
  },

  // ุงููููุงุช ูุงูุชุฎุตุตุงุช
  faculties: {
    'ูููุฉ ุชูููููุฌูุง ุงููุนูููุงุช': [
      'ุนููู ุงูุญุงุณูุจ',
      'ููุฏุณุฉ ุงูุจุฑูุฌูุงุช', 
      'ูุธู ุงููุนูููุงุช ุงูุญุงุณูุจูุฉ',
      'ุงูุฐูุงุก ุงูุงุตุทูุงุนู',
      'ุงูุฃูู ุงูุณูุจุฑุงูู'
    ],
    'ูููุฉ ุงูุฃุนูุงู': [
      'ุฅุฏุงุฑุฉ ุงูุฃุนูุงู',
      'ุงููุญุงุณุจุฉ',
      'ุงูุชูููู ูุงููุตุงุฑู',
      'ุงูุชุณููู',
      'ุงูุงูุชุตุงุฏ'
    ],
    'ูููุฉ ุงูููุฏุณุฉ': [
      'ุงูููุฏุณุฉ ุงููุฏููุฉ',
      'ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ',
      'ุงูููุฏุณุฉ ุงููููุงููููุฉ',
      'ููุฏุณุฉ ุงูุนูุงุฑุฉ'
    ],
    'ูููุฉ ุงูุขุฏุงุจ ูุงูุนููู': [
      'ุงููุบุฉ ุงูุนุฑุจูุฉ ูุขุฏุงุจูุง',
      'ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ูุขุฏุงุจูุง',
      'ุงูุชุฑุฌูุฉ',
      'ุนูู ุงูููุณ',
      'ุงูุฑูุงุถูุงุช'
    ],
    'ูููุฉ ุงูุญููู': [
      'ุงููุงููู'
    ],
    'ูููุฉ ุงูุฅุนูุงู': [
      'ุงูุตุญุงูุฉ ูุงูุฅุนูุงู',
      'ุงูุนูุงูุงุช ุงูุนุงูุฉ ูุงูุฅุนูุงู'
    ]
  },

  // ุงูุฎุฏูุงุช ูุงููุฑุงูู
  facilities: {
    'ุงูููุชุจุฉ': 'ููุชุจุฉ ูุฑูุฒูุฉ ูุฌูุฒุฉ ุจุฃุญุฏุซ ุงูุชูููุงุช. ููุชูุญุฉ ูู 8 ุตุจุงุญุงู ุญุชู 8 ูุณุงุกู. ุชุญุชูู ุนูู ุฃูุซุฑ ูู 50,000 ูุชุงุจ ูููุงุนุฏ ุจูุงูุงุช ุฅููุชุฑูููุฉ.',
    'ุงููุฎุชุจุฑุงุช': 'ูุฎุชุจุฑุงุช ุญุงุณูุจ ูุชุทูุฑุฉุ ูุฎุชุจุฑุงุช ุนูููุฉ ูุฌูุฒุฉุ ูุฎุชุจุฑุงุช ููุฏุณูุฉ ูุชุฎุตุตุฉ.',
    'ุงููุงุนุงุช': 'ูุงุนุงุช ุฏุฑุงุณูุฉ ููููุฉ ููุฌูุฒุฉ ุจุฃุฌูุฒุฉ ุนุฑุถ ุญุฏูุซุฉ. ูุฏุฑุฌ ูุจูุฑ ูุชุณุน ูู 300 ุทุงูุจ.',
    'ุงููุงูุชูุฑูุง': 'ูุงูุชูุฑูุง ุฑุฆูุณูุฉ ุชูุฏู ูุฌุจุงุช ูุชููุนุฉ. ููุชูุญุฉ ูู 7:30 ุตุจุงุญุงู ุญุชู 6 ูุณุงุกู.',
    'ุงูููุงูู': 'ููุงูู ูุฌุงููุฉ ููุทูุจุฉ ูุฃุนุถุงุก ููุฆุฉ ุงูุชุฏุฑูุณ. ููุงูู ูุธููุฉ ูููุงูู ููุชูุญุฉ.',
    'ุงูููุงุนุจ': 'ููุนุจ ูุฑุฉ ูุฏูุ ููุนุจ ูุฑุฉ ุณูุฉุ ุตุงูุฉ ุฑูุงุถูุฉ ูุบููุฉ.',
    'ุงูุนูุงุฏุฉ': 'ุนูุงุฏุฉ ุทุจูุฉ ูุชูุฏูู ุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ ูุงูุงุณุชุดุงุฑุงุช ุงูุทุจูุฉ.'
  },

  // ุงูุงูุชุญุงูุงุช ูุงูุฏุฑุฌุงุช
  exams: {
    'ุงููุตูู': 'ุงูุชุญุงูุงุช ูุตู ุงููุตู ุชูุนูุฏ ูู ุงูุฃุณุจูุน ุงูุซุงูู ูู ุงููุตู. ุชุดูู 30% ูู ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ.',
    'ุงูููุงุฆู': 'ุงูุงูุชุญุงู ุงูููุงุฆู ูุดูู 40% ูู ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ. ููุนูุฏ ูู ููุงูุฉ ุงููุตู ุญุณุจ ุงูุฌุฏูู ุงููุนูู.',
    'ุงูุฃุนูุงู': 'ุฃุนูุงู ุงููุตู ุชุดูู ุงููุงุฌุจุงุช ูุงููุดุงุฑูุน ูุงูุงุฎุชุจุงุฑุงุช ุงููุตูุฑุฉ ูุชุดูู 30% ูู ุงูุฏุฑุฌุฉ.',
    'ุงููุนุฏู': 'ุงููุนุฏู ูู 4.0. ุงูุญุฏ ุงูุฃุฏูู ูููุฌุงุญ ูู 2.0. ุงูุฅูุฐุงุฑ ุงูุฃูุงุฏููู ุนูุฏ ุงูุฎูุงุถ ุงููุนุฏู ุนู 2.0.',
    'ุงูุชูุฏูุฑุงุช': 'A: 90-100ุ B: 80-89ุ C: 70-79ุ D: 60-69ุ F: ุฃูู ูู 60'
  },

  // ูุนูููุงุช ุงูุงุชุตุงู
  contact: {
    'ุงููุงุชู': '+962-6-4291511',
    'ุงูุนููุงู': 'ูุทุงุฑ ุงููููุฉ ุนููุงุก ุงูุฏูููุ ุนูุงูุ ุงูุฃุฑุฏู',
    'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู': 'info@meu.edu.jo',
    'ุณุงุนุงุช ุงูุนูู': 'ุงูุฃุญุฏ - ุงูุฎููุณ: 8:00 ุต - 4:00 ู',
    'ุงููุจูู ูุงูุชุณุฌูู': 'admission@meu.edu.jo',
    'ุงูุดุคูู ุงููุงููุฉ': 'finance@meu.edu.jo'
  }
};

// ุฅุนุฏุงุฏ OpenAI client
const openai = new OpenAI({
  apiKey: 'demo-key', // ูุคูุช ููุชุทููุฑ
  dangerouslyAllowBrowser: true
});

// ูุธููุฉ ููุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ
const searchLocalKnowledge = (question) => {
  const lowerQuestion = question.toLowerCase();
  
  // ุงูุจุญุซ ูู ูุนูููุงุช ุงูุชุณุฌูู
  for (const [key, value] of Object.entries(MEU_KNOWLEDGE_BASE.registration)) {
    if (lowerQuestion.includes(key.toLowerCase()) || 
        lowerQuestion.includes('ุชุณุฌูู') || 
        lowerQuestion.includes('ุฑุณูู') ||
        lowerQuestion.includes('ููุญ') ||
        lowerQuestion.includes('ุงูุณุญุงุจ') ||
        lowerQuestion.includes('ุชุฃุฌูู')) {
      return `๐ **${key}:**\n\n${value}\n\nููุฒูุฏ ูู ุงููุนูููุงุชุ ูุฑุฌู ุงูุชูุงุตู ูุน ุนูุงุฏุฉ ุงููุจูู ูุงูุชุณุฌูู ุนูู: admission@meu.edu.jo`;
    }
  }

  // ุงูุจุญุซ ูู ุงููููุงุช ูุงูุชุฎุตุตุงุช
  if (lowerQuestion.includes('ุชุฎุตุต') || lowerQuestion.includes('ูููุฉ') || lowerQuestion.includes('ูุณู')) {
    let response = '๐๏ธ **ุงููููุงุช ูุงูุชุฎุตุตุงุช ูู ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท:**\n\n';
    for (const [faculty, majors] of Object.entries(MEU_KNOWLEDGE_BASE.faculties)) {
      response += `**${faculty}:**\n${majors.map(major => `โข ${major}`).join('\n')}\n\n`;
    }
    return response + 'ููุฒูุฏ ูู ุงูุชูุงุตูู ุญูู ุฃู ุชุฎุตุตุ ูุฑุฌู ุฒูุงุฑุฉ ุงููููุน ุงูุฅููุชุฑููู: www.meu.edu.jo';
  }

  // ุงูุจุญุซ ูู ุงููุฑุงูู ูุงูุฎุฏูุงุช
  for (const [key, value] of Object.entries(MEU_KNOWLEDGE_BASE.facilities)) {
    if (lowerQuestion.includes(key.toLowerCase()) ||
        lowerQuestion.includes('ููุชุจุฉ') ||
        lowerQuestion.includes('ูุฎุชุจุฑ') ||
        lowerQuestion.includes('ูุงูุชูุฑูุง') ||
        lowerQuestion.includes('ูููู') ||
        lowerQuestion.includes('ููุนุจ')) {
      return `๐ข **${key}:**\n\n${value}`;
    }
  }

  // ุงูุจุญุซ ูู ูุนูููุงุช ุงูุงูุชุญุงูุงุช
  if (lowerQuestion.includes('ุงูุชุญุงู') || lowerQuestion.includes('ุฏุฑุฌุฉ') || 
      lowerQuestion.includes('ูุนุฏู') || lowerQuestion.includes('ูุชุงุฆุฌ')) {
    let response = '๐ **ูุนูููุงุช ุงูุงูุชุญุงูุงุช ูุงูุฏุฑุฌุงุช:**\n\n';
    for (const [key, value] of Object.entries(MEU_KNOWLEDGE_BASE.exams)) {
      response += `**${key}:** ${value}\n\n`;
    }
    return response;
  }

  // ูุนูููุงุช ุงูุงุชุตุงู
  if (lowerQuestion.includes('ุงุชุตุงู') || lowerQuestion.includes('ูุงุชู') || 
      lowerQuestion.includes('ุนููุงู') || lowerQuestion.includes('ูููุน')) {
    let response = '๐ **ูุนูููุงุช ุงูุชูุงุตู:**\n\n';
    for (const [key, value] of Object.entries(MEU_KNOWLEDGE_BASE.contact)) {
      response += `**${key}:** ${value}\n\n`;
    }
    return response;
  }

  // ูุนูููุงุช ุนุงูุฉ ุนู ุงูุฌุงูุนุฉ
  if (lowerQuestion.includes('ุฌุงูุนุฉ') || lowerQuestion.includes('meu') || 
      lowerQuestion.includes('ุดุฑู ุงูุฃูุณุท') || lowerQuestion.includes('ุนู ุงูุฌุงูุนุฉ')) {
    const general = MEU_KNOWLEDGE_BASE.general;
    return `๐๏ธ **ุนู ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท:**\n\n` +
           `โข **ุงูุงุณู:** ${general.name} (${general.englishName})\n` +
           `โข **ุงููููุน:** ${general.location}\n` +
           `โข **ุชุฃุณุณุช:** ${general.founded}\n` +
           `โข **ุงูููุน:** ${general.type}\n` +
           `โข **ุงูุงุนุชูุงุฏ:** ${general.accreditation}\n` +
           `โข **ุงููููุน ุงูุฅููุชุฑููู:** ${general.website}\n\n` +
           `ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท ูู ุฅุญุฏู ุงูุฌุงูุนุงุช ุงูุฑุงุฆุฏุฉ ูู ุงูููุทูุฉุ ุชูุฏู ุชุนูููุงู ุนุงูู ุงูุฌูุฏุฉ ูู ุจูุฆุฉ ุฃูุงุฏูููุฉ ูุชููุฒุฉ.`;
  }

  return null;
};

// ูุธููุฉ ููุญุตูู ุนูู ุฅุฌุงุจุฉ ูู ุงูุฐูู ุงูุงุตุทูุงุนู
export const getAIResponse = async (question) => {
  try {
    // ุฃููุงูุ ุงุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ
    const localResponse = searchLocalKnowledge(question);
    if (localResponse) {
      return localResponse;
    }

    // ุฅุฌุงุจุงุช ุชุฌุฑูุจูุฉ ูุญุณูุฉ ููุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ
    const enhancedResponses = {
      'ูุฑุญุจุง': 'ูุฑุญุจุงู ุจู ูู Ask MEU! ๐\n\nุฃูุง ูุณุงุนุฏู ุงูุฐูู ูุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท. ูููููู ูุณุงุนุฏุชู ูู:\n\nโข ูุนูููุงุช ุงูุชุณุฌูู ูุงูุฑุณูู\nโข ุงูุชุฎุตุตุงุช ูุงููููุงุช\nโข ุงููุฑุงูู ูุงูุฎุฏูุงุช\nโข ุงูุงูุชุญุงูุงุช ูุงูุฏุฑุฌุงุช\nโข ูุนูููุงุช ุงูุงุชุตุงู\n\nููู ูููููู ูุณุงุนุฏุชู ุงููููุ',
      
      'ุดูุฑุง': 'ุงูุนูู! ๐ ุฃุชููู ุฃู ุชููู ุงููุนูููุงุช ูููุฏุฉ ูู. ุฅุฐุง ูุงู ูุฏูู ุฃู ุฃุณุฆูุฉ ุฃุฎุฑู ุญูู ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุทุ ูุง ุชุชุฑุฏุฏ ูู ุงูุณุคุงู!',
      
      'ููุช': 'ุณุงุนุงุช ุงูุนูู ูู ุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท:\n\n๐ **ุงูุฏูุงู ุงูุฑุณูู:**\nุงูุฃุญุฏ - ุงูุฎููุณ: 8:00 ุต - 4:00 ู\n\n๐ **ุงูููุชุจุฉ:**\nุงูุฃุญุฏ - ุงูุฎููุณ: 8:00 ุต - 8:00 ู\n\n๐ฝ๏ธ **ุงููุงูุชูุฑูุง:**\nุงูุฃุญุฏ - ุงูุฎููุณ: 7:30 ุต - 6:00 ู',
      
      'ูุณุงุนุฏุฉ': 'ูููููู ูุณุงุนุฏุชู ูู ุงูุนุฏูุฏ ูู ุงูุฃููุฑ ุงููุชุนููุฉ ุจุฌุงูุนุฉ ุงูุดุฑู ุงูุฃูุณุท:\n\n๐ **ุงูุฃูุงุฏูููุฉ:**\nโข ุงูุชุณุฌูู ูุฅูุบุงุก ุงูุชุณุฌูู\nโข ุงูุฑุณูู ูุงูููุญ\nโข ุงูุชุฎุตุตุงุช ูุงูููุงูุฌ\nโข ุงูุงูุชุญุงูุงุช ูุงูุฏุฑุฌุงุช\n\n๐ข **ุงูุฎุฏูุงุช:**\nโข ุงููุฑุงูู ุงูุฌุงูุนูุฉ\nโข ุงูููุชุจุฉ ูุงููุฎุชุจุฑุงุช\nโข ุงูุฃูุดุทุฉ ุงูุทูุงุจูุฉ\n\n๐ **ุงูุชูุงุตู:**\nโข ุฃุฑูุงู ุงูููุงุชู\nโข ุงูุนูุงููู ุงูุฅููุชุฑูููุฉ\nโข ุณุงุนุงุช ุงูุนูู\n\nุงุณุฃู ุนู ุฃู ููุถูุน ุชุฑูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนูู!'
    };

    // ูุญุงูุงุฉ ุชุฃุฎูุฑ ุงูุดุจูุฉ
    await new Promise(resolve => setTimeout(resolve, 1200));

    // ุงูุจุญุซ ุนู ุฅุฌุงุจุฉ ููุงุณุจุฉ
    for (let key in enhancedResponses) {
      if (question.toLowerCase().includes(key)) {
        return enhancedResponses[key];
      }
    }
    
    // ุฅุฌุงุจุฉ ุงูุชุฑุงุถูุฉ ูุญุณูุฉ
    return `ุดูุฑุงู ูู ุนูู ุณุคุงูู! ๐ค\n\nูู ุฃุฌุฏ ุฅุฌุงุจุฉ ูุญุฏุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉุ ูููู ููููู:\n\n๐ **ุงูุชูุงุตู ุงููุจุงุดุฑ:**\nโข ุงููุงุชู: +962-6-4291511\nโข ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: info@meu.edu.jo\n\n๐ **ุฒูุงุฑุฉ ุงููููุน ุงูุฅููุชุฑููู:**\nwww.meu.edu.jo\n\n๐ข **ุฒูุงุฑุฉ ุงูุฌุงูุนุฉ:**\nูุทุงุฑ ุงููููุฉ ุนููุงุก ุงูุฏูููุ ุนูุงูุ ุงูุฃุฑุฏู\n\nูุฑูู ุงูุฏุนู ุณูููู ุณุนูุฏุงู ููุณุงุนุฏุชู! ๐`;
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุงุชุตุงู ูุน ุงูุฐูู ุงูุงุตุทูุงุนู:', error);
    return 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู ูุคูุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชูุงุตู ูุน ุงูุฏุนู ุงูุชููู ุนูู: info@meu.edu.jo ๐ง';
  }
};

// ูุธููุฉ ูุชุญููู ููุน ุงูุณุคุงู (ูุญุณูุฉ)
export const analyzeQuestion = (question) => {
  const lowerQuestion = question.toLowerCase();
  
  const categories = {
    registration: ['ุชุณุฌูู', 'ุฑุณูู', 'ููุญ', 'ูุจูู', 'ุชุฃุฌูู', 'ุงูุณุญุงุจ'],
    academic: ['ุชุฎุตุต', 'ูููุฉ', 'ูุงุฏุฉ', 'ููุฑุฑ', 'ูููุฌ', 'ุฏุฑุงุณุฉ'],
    facilities: ['ููุชุจุฉ', 'ูุฎุชุจุฑ', 'ูุงูุชูุฑูุง', 'ูููู', 'ููุนุจ', 'ูุงุนุฉ'],
    exams: ['ุงูุชุญุงู', 'ุฏุฑุฌุฉ', 'ูุนุฏู', 'ูุชูุฌุฉ', 'ุชูุฏูุฑ'],
    contact: ['ุงุชุตุงู', 'ูุงุชู', 'ุนููุงู', 'ูููุน', 'ุจุฑูุฏ'],
    general: ['ุฌุงูุนุฉ', 'ูุนูููุงุช', 'ุนู', 'meu']
  };

  for (const [category, keywords] of Object.entries(categories)) {
    if (keywords.some(keyword => lowerQuestion.includes(keyword))) {
      return category;
    }
  }
  
  return 'general';
};